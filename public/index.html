<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Bot - Panel de Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">📱</div>
                <h1 class="text-2xl font-bold text-gray-800">WhatsApp Bot</h1>
                <p class="text-gray-500">Panel de Control</p>
            </div>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
                    <input type="text" id="username" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none" placeholder="Ingresa tu usuario">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                    <input type="password" id="password" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none" placeholder="Ingresa tu contraseña">
                </div>
                <div id="loginError" class="text-red-500 text-sm text-center hidden"></div>
                <button type="submit" class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors">Iniciar Sesión</button>
            </form>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" class="hidden flex min-h-screen">
        <!-- SIDEBAR -->
        <aside class="sidebar fixed left-0 top-0 h-full w-64 bg-white shadow-lg z-10 flex flex-col">
            <div class="p-6 border-b">
                <div class="flex items-center gap-3">
                    <span class="text-3xl">📱</span>
                    <div>
                        <h1 class="font-bold text-gray-800">WhatsApp Bot</h1>
                        <p class="text-xs text-gray-500">Panel de Control</p>
                    </div>
                </div>
            </div>
            <nav class="flex-1 p-4">
                <ul class="space-y-2">
                    <li>
                        <button id="nav-sessions" onclick="showSection('sessions')" class="sidebar-item active w-full text-left px-4 py-3 rounded-lg flex items-center gap-3">
                            <span>📋</span><span>Sesiones</span>
                        </button>
                    </li>
                    <li>
                        <button id="nav-monitor" onclick="showSection('monitor')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3">
                            <span>📊</span><span>Monitor</span>
                        </button>
                    </li>
                    <li>
                        <button id="nav-search" onclick="showSection('search')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3">
                            <span>🔍</span><span>Búsqueda</span>
                        </button>
                    </li>
                    <li>
                        <button id="nav-personal" onclick="showSection('personal')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3">
                            <span>💬</span><span>Mensaje Personal</span>
                        </button>
                    </li>
                    <li>
                        <button id="nav-bulk" onclick="showSection('bulk')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3">
                            <span>📤</span><span>Envío Masivo</span>
                        </button>
                    </li>
                    <li>
                        <button id="nav-analytics" onclick="showSection('analytics')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3">
                            <span>📈</span><span>Analytics</span>
                        </button>
                    </li>
                    <li>
                        <button id="nav-conversation" onclick="showSection('conversation')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3">
                            <span>🤖</span><span>Conversación IA</span>
                        </button>
                    </li>
                    <li>
                        <button id="nav-settings" onclick="showSection('settings')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3">
                            <span>⚙️</span><span>Configuración</span>
                        </button>
                    </li>
                    <li>
                        <button id="nav-database" onclick="showSection('database')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3">
                            <span>🗄️</span><span>Base de Datos</span>
                        </button>
                    </li>
                    <li>
                        <button id="nav-webhooks" onclick="showSection('webhooks')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3">
                            <span>📨</span><span>Centro de Mensajes</span>
                        </button>
                    </li>
                </ul>
            </nav>
            <div class="absolute bottom-0 left-0 right-0 p-4 border-t bg-gray-50">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-sm text-gray-600">⏱️ Sesión:</span>
                    <span id="sessionTimer" class="font-mono text-green-600 font-bold">5:00</span>
                </div>
                <button onclick="logout()" class="w-full bg-red-500 text-white py-2 rounded-lg text-sm hover:bg-red-600 transition-colors">🚪 Cerrar Sesión</button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 ml-64 p-6">
            <header class="bg-white rounded-lg shadow p-4 mb-6 flex justify-between items-center">
                <div>
                    <h2 id="sectionTitle" class="text-xl font-bold text-gray-800">Sesiones de WhatsApp</h2>
                    <p id="sectionSubtitle" class="text-sm text-gray-500">Gestiona tus conexiones de WhatsApp</p>
                </div>
                <div class="text-right">
                    <div id="activeSessionsCount" class="text-sm text-gray-600 mb-1"></div>
                    <div class="flex items-center gap-2 justify-end">
                        <div id="rotationInfo" class="text-xs text-purple-600 font-medium"></div>
                        <button onclick="rotateSessionManually()" id="rotateBtn" class="bg-purple-500 text-white px-3 py-1 text-xs rounded-lg hover:bg-purple-600 transition-colors flex items-center gap-1" title="Rotar sesión manualmente">
                            🔄 Rotar
                        </button>
                    </div>
                </div>
            </header>

            <!-- SECTION: SESSIONS -->
            <section id="section-sessions" class="section-content active">
                <!-- Network Info Banner -->
                <div id="networkInfoDisplay" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg shadow p-4 mb-6">
                    <div class="flex items-center gap-2 text-sm">
                        <span class="font-bold">🌐 IP:</span>
                        <span class="font-mono font-bold text-lg">Cargando...</span>
                    </div>
                </div>
                
                <!-- Cloud API Stats Card -->
                <div id="cloudApiCard" class="bg-gradient-to-br from-blue-500 to-cyan-600 rounded-lg shadow-lg p-6 mb-6 text-white">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">☁️</span>
                            <div>
                                <h3 class="text-lg font-bold">WhatsApp Cloud API</h3>
                                <p class="text-blue-100 text-sm">Meta Business API Oficial</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="cloudApiStatus" class="bg-green-400 text-green-900 px-3 py-1 rounded-full text-xs font-bold">● ACTIVA</span>
                            <span id="cloudApiAccountStatus" class="bg-yellow-400 text-yellow-900 px-3 py-1 rounded-full text-xs font-bold hidden">⏳ CUENTA PENDIENTE</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white/20 rounded-lg p-3 text-center">
                            <div id="cloudApiToday" class="text-2xl font-bold">0</div>
                            <div class="text-xs text-blue-100">Hoy</div>
                        </div>
                        <div class="bg-white/20 rounded-lg p-3 text-center">
                            <div id="cloudApiHour" class="text-2xl font-bold">0</div>
                            <div class="text-xs text-blue-100">Última hora</div>
                        </div>
                        <div class="bg-white/20 rounded-lg p-3 text-center">
                            <div id="cloudApiTotal" class="text-2xl font-bold">0</div>
                            <div class="text-xs text-blue-100">Total</div>
                        </div>
                        <div class="bg-white/20 rounded-lg p-3 text-center">
                            <div id="cloudApiPercentage" class="text-2xl font-bold">50%</div>
                            <div class="text-xs text-blue-100">Distribución</div>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-white/20">
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-blue-100">📞 Número: <span id="cloudApiPhone" class="font-mono">-</span></span>
                            <span id="cloudApiHybridStatus" class="text-blue-100">Modo: -</span>
                        </div>
                        <!-- Estado de cuenta y controles -->
                        <div id="cloudApiAccountInfo" class="mt-3 pt-3 border-t border-white/20">
                            <div class="flex items-center justify-between">
                                <div id="cloudApiAccountError" class="text-yellow-200 text-xs hidden">
                                    ⚠️ <span id="cloudApiErrorText">Cuenta no registrada</span>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="enableCloudApi()" id="btnEnableCloud" class="bg-green-400 hover:bg-green-300 text-green-900 px-3 py-1 rounded text-xs font-bold transition-colors hidden">
                                        ✓ Habilitar Cloud API
                                    </button>
                                    <button onclick="disableCloudApi()" id="btnDisableCloud" class="bg-red-400 hover:bg-red-300 text-red-900 px-3 py-1 rounded text-xs font-bold transition-colors hidden">
                                        ✕ Deshabilitar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">➕ Crear Nueva Sesión Baileys</h3>
                    <div class="flex gap-4">
                        <input type="text" id="sessionName" placeholder="Nombre de la sesión (ej: MiEmpresa)" class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none">
                        <button onclick="createSession()" id="createSessionBtn" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition-colors">Crear Sesión</button>
                    </div>
                    <p id="createSessionStatus" class="mt-2 text-sm"></p>
                </div>
                <h3 class="text-lg font-semibold mb-4 text-gray-700">📱 Sesiones Baileys</h3>
                <div id="sessionsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="col-span-full text-center p-8">
                        <div class="spinner mx-auto mb-4"></div>
                        <p class="text-gray-600">Cargando sesiones...</p>
                    </div>
                </div>
            </section>

            <!-- SECTION: PERSONAL MESSAGE -->
            <section id="section-personal" class="section-content">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">💬 Enviar Mensaje Personalizado</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sesiones (selecciona una o varias)</label>
                                <div id="personalSessionCheckboxes" class="border rounded-lg p-3 max-h-32 overflow-y-auto bg-gray-50">
                                    <p class="text-gray-500 text-sm">Cargando sesiones...</p>
                                </div>
                                <div class="flex gap-2 mt-2">
                                    <button onclick="selectAllPersonalSessions()" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200">Seleccionar todas</button>
                                    <button onclick="deselectAllPersonalSessions()" class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-gray-200">Deseleccionar todas</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Número de Teléfono</label>
                                <input type="text" id="personalPhone" placeholder="573196319531" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Archivo (opcional)</label>
                                <input type="file" id="personalFile" accept="image/*,video/*,audio/*,.pdf,.doc,.docx" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Mensaje</label>
                                <textarea id="personalMessage" placeholder="Escribe tu mensaje aquí..." class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none h-32"></textarea>
                            </div>
                            <button onclick="sendPersonalMessage()" id="sendPersonalBtn" class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition-colors font-semibold">📨 Enviar Mensaje</button>
                            <div id="personalStatus" class="text-sm"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SECTION: BULK SEND -->
            <section id="section-bulk" class="section-content">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">📤 Envío Masivo de Mensajes</h3>

                    <!-- Tabs -->
                    <div class="mb-4 border-b">
                        <div class="flex">
                            <button id="tabNumbers" onclick="switchBulkTab('numbers')" class="px-4 py-2 border-b-2 border-purple-500 text-purple-600 font-medium">📱 Números de Teléfono</button>
                            <button id="tabGroups" onclick="switchBulkTab('groups')" class="px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">👥 Grupos de WhatsApp</button>
                        </div>
                    </div>

                    <!-- Panel Numbers -->
                    <div id="panelNumbers" class="mb-4">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sesiones de WhatsApp (selecciona una o varias)</label>
                            <div id="bulkSessionCheckboxes" class="border rounded-lg p-3 max-h-32 overflow-y-auto bg-gray-50">
                                <p class="text-gray-500 text-sm">Cargando sesiones...</p>
                            </div>
                            <div class="flex gap-2 mt-2">
                                <button onclick="selectAllBulkSessions()" class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded hover:bg-purple-200">Seleccionar todas</button>
                                <button onclick="deselectAllBulkSessions()" class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-gray-200">Deseleccionar todas</button>
                            </div>
                        </div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lista de Números (uno por línea)</label>
                        <textarea id="bulkContacts" placeholder="573196319531
573123456789
573987654321" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none h-32"></textarea>
                        <p class="text-xs text-gray-500 mt-1">Formato: código país + número. Un número por línea. Máximo 50.</p>
                    </div>

                    <!-- Panel Groups -->
                    <div id="panelGroups" class="mb-4 hidden">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Seleccionar Sesión de WhatsApp</label>
                            <select id="groupSessionSelect" onchange="loadGroupsFromSession()" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none bg-white">
                                <option value="">-- Selecciona una sesión --</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Los grupos se cargarán de la sesión seleccionada</p>
                        </div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Seleccionar Grupos</label>
                        <div id="groupsList" class="border rounded-lg p-3 max-h-48 overflow-y-auto bg-gray-50">
                            <p class="text-gray-500 text-sm">Selecciona una sesión para ver los grupos</p>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <button onclick="selectAllGroups()" class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded hover:bg-purple-200">Seleccionar todos</button>
                            <button onclick="deselectAllGroups()" class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-gray-200">Deseleccionar todos</button>
                        </div>
                    </div>

                    <!-- Message and file -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mensaje</label>
                            <textarea id="bulkMessage" placeholder="Mensaje para envío masivo..." class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none h-24"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Archivo (opcional)</label>
                            <input type="file" id="bulkFileInput" accept="image/*,video/*,audio/*,.pdf,.doc,.docx" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
                            <div class="mt-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Delay (segundos)</label>
                                <input type="number" id="bulkDelay" value="3" min="1" max="10" class="w-20 px-2 py-1 border rounded-lg">
                            </div>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div class="flex gap-4 flex-wrap">
                        <button onclick="sendBulkMessages()" id="sendBulkBtn" class="bg-purple-500 text-white px-6 py-2 rounded-lg hover:bg-purple-600 transition-colors">🚀 Enviar Masivo</button>
                        <button onclick="clearBulkForm()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">🗑️ Limpiar</button>
                    </div>

                    <!-- Status -->
                    <div id="bulkStatus" class="mt-4 text-sm"></div>
                    <div id="bulkProgress" class="mt-2 hidden">
                        <div class="bg-gray-200 rounded-full h-2">
                            <div id="bulkProgressBar" class="bg-purple-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                        <p id="bulkProgressText" class="text-xs text-gray-600 mt-1"></p>
                    </div>
                </div>
            </section>

            <!-- SECTION: MONITOR -->
            <section id="section-monitor" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="bg-gradient-to-br from-purple-500 to-indigo-600 rounded-lg shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold">🔥 Sesión Activa</h3>
                            <span class="text-2xl">📱</span>
                        </div>
                        <div id="monitorActiveSession" class="text-3xl font-bold mb-2">-</div>
                        <p class="text-purple-200 text-sm">Enviando mensajes actualmente</p>
                    </div>
                    
                    <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold">✅ Mensajes Enviados</h3>
                            <span class="text-2xl">📨</span>
                        </div>
                        <div id="monitorTotalMessages" class="text-3xl font-bold mb-2">0</div>
                        <p class="text-green-200 text-sm">Total de esta sesión</p>
                    </div>
                    
                    <div class="bg-gradient-to-br from-orange-500 to-amber-600 rounded-lg shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold">🔄 Próxima Rotación</h3>
                            <span class="text-2xl">⏱️</span>
                        </div>
                        <div id="monitorNextRotation" class="text-3xl font-bold mb-2">--:--</div>
                        <p class="text-orange-200 text-sm">Tiempo restante</p>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">📊 Estadísticas por Sesión</h3>
                        <button onclick="refreshMonitorStats()" class="bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-lg text-sm transition-colors">🔄 Actualizar</button>
                    </div>
                    <div id="monitorSessionStats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <p class="text-gray-500 col-span-full text-center">Cargando estadísticas...</p>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow mb-6">
                    <div class="flex justify-between items-center p-6 pb-4">
                        <h3 class="text-lg font-semibold">📝 Mensajes Recientes</h3>
                        <div class="flex gap-2">
                            <button onclick="toggleMonitorAutoRefresh()" id="monitorAutoRefreshBtn" class="bg-green-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-green-600 transition-colors">▶️ Auto</button>
                            <button onclick="clearMonitorLog()" class="bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-lg text-sm transition-colors">🗑️ Limpiar</button>
                        </div>
                    </div>
                    <div class="px-6 pb-6">
                        <div id="monitorMessageLog" class="bg-gray-900 rounded-lg p-4 h-80 overflow-y-auto font-mono text-sm">
                            <p class="text-gray-500">Esperando mensajes...</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow mb-6">
                    <div class="flex justify-between items-center p-6 pb-4">
                        <h3 class="text-lg font-semibold">📅 Historial de Mensajes</h3>
                        <button onclick="loadHistory()" class="bg-purple-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-purple-600 transition-colors">🔄 Actualizar</button>
                    </div>
                    <div class="px-6 pb-6">
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-700 mb-3">📆 Por Fecha</h4>
                            <div id="historyByDate" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <p class="text-gray-500 col-span-full text-center">Cargando...</p>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-3">📱 Por Sesión</h4>
                            <div id="historyBySession" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <p class="text-gray-500 col-span-full text-center">Cargando...</p>
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <h4 class="font-semibold text-gray-700 mb-3">Historial de Cola</h4>
                            <div id="historyQueue" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <p class="text-gray-500 col-span-full text-center">Cargando...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow mb-6">
                    <div class="flex justify-between items-center p-6 pb-4">
                        <h3 class="text-lg font-semibold">📥 Cola de Mensajes</h3>
                        <div class="flex gap-2">
                            <button onclick="markAllAsSent()" id="btnMarkAllSent" class="bg-green-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-green-600 transition-colors">✅ Marcar todos como enviados</button>
                            <button onclick="loadQueueMessages()" class="bg-orange-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-orange-600 transition-colors">🔄 Actualizar</button>
                        </div>
                    </div>
                    <div class="px-6 pb-6">
                        <!-- Pestañas Pendientes/Enviados -->
                        <div class="flex border-b border-gray-200 mb-4">
                            <button id="tabPending" onclick="switchQueueTab('pending')" class="px-4 py-2 text-sm font-medium text-orange-600 border-b-2 border-orange-500">
                                ⏳ Pendientes <span id="pendingCount" class="bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full text-xs ml-1">0</span>
                            </button>
                            <button id="tabSent" onclick="switchQueueTab('sent')" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-green-600">
                                ✅ Enviados Hoy <span id="sentTodayCount" class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full text-xs ml-1">0</span>
                            </button>
                        </div>
                        
                        <div id="queueStats" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="bg-orange-50 border border-orange-200 rounded-lg p-3 text-center">
                                <div id="queueTotalNumbers" class="text-2xl font-bold text-orange-600">0</div>
                                <div class="text-sm text-orange-700">Números en cola</div>
                            </div>
                            <div class="bg-orange-50 border border-orange-200 rounded-lg p-3 text-center">
                                <div id="queueTotalMessages" class="text-2xl font-bold text-orange-600">0</div>
                                <div class="text-sm text-orange-700">Mensajes pendientes</div>
                            </div>
                            <div class="bg-green-50 border border-green-200 rounded-lg p-3 text-center">
                                <div id="queueSentToday" class="text-2xl font-bold text-green-600">0</div>
                                <div class="text-sm text-green-700">Enviados hoy</div>
                            </div>
                        </div>
                        
                        <div id="queueMessageList" class="bg-gray-50 rounded-lg p-4 max-h-80 overflow-y-auto">
                            <p class="text-gray-500 text-center">Sin mensajes en cola</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SECTION: BÚSQUEDA -->
            <section id="section-search" class="section-content">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">🔍 Búsqueda de Mensajes</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Número de teléfono</label>
                            <select id="searchPhone" class="w-full rounded-lg border-gray-300 shadow-sm p-2.5 border">
                                <option value="">Todos los números</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Sesión</label>
                            <select id="searchSession" class="w-full rounded-lg border-gray-300 shadow-sm p-2.5 border">
                                <option value="">Todas las sesiones</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Fecha inicio</label>
                            <input type="date" id="searchStartDate" class="w-full rounded-lg border-gray-300 shadow-sm p-2.5 border">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Fecha fin</label>
                            <input type="date" id="searchEndDate" class="w-full rounded-lg border-gray-300 shadow-sm p-2.5 border">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Mostrar</label>
                            <select id="searchLimit" class="w-full rounded-lg border-gray-300 shadow-sm p-2.5 border">
                                <option value="25">25</option>
                                <option value="50" selected>50</option>
                                <option value="100">100</option>
                                <option value="200">200</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="searchMessages()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors">🔍 Buscar</button>
                        <button onclick="clearSearchFilters()" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors">🗑️ Limpiar</button>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">📋 Resultados <span id="searchResultCount" class="text-gray-500 text-sm font-normal"></span></h3>
                        <div id="searchPagination" class="flex gap-2"></div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm" id="searchTable">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left font-medium text-gray-600 cursor-pointer hover:bg-gray-100 select-none" onclick="sortSearchTable('timestamp')">
                                        Fecha/Hora <span id="searchSort_timestamp" class="text-xs">↕</span>
                                    </th>
                                    <th class="px-4 py-3 text-left font-medium text-gray-600 cursor-pointer hover:bg-gray-100 select-none" onclick="sortSearchTable('session')">
                                        Sesión <span id="searchSort_session" class="text-xs">↕</span>
                                    </th>
                                    <th class="px-4 py-3 text-left font-medium text-gray-600 cursor-pointer hover:bg-gray-100 select-none" onclick="sortSearchTable('phone_number')">
                                        Número <span id="searchSort_phone_number" class="text-xs">↕</span>
                                    </th>
                                    <th class="px-4 py-3 text-left font-medium text-gray-600">Mensaje</th>
                                    <th class="px-4 py-3 text-left font-medium text-gray-600 cursor-pointer hover:bg-gray-100 select-none" onclick="sortSearchTable('char_count')">
                                        Chars <span id="searchSort_char_count" class="text-xs">↕</span>
                                    </th>
                                    <th class="px-4 py-3 text-left font-medium text-gray-600 cursor-pointer hover:bg-gray-100 select-none" onclick="sortSearchTable('status')">
                                        Estado <span id="searchSort_status" class="text-xs">↕</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="searchResultsTable" class="divide-y divide-gray-200">
                                <tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">Selecciona filtros y haz clic en Buscar</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- SECTION: ANALYTICS -->
            <section id="section-analytics" class="section-content">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 items-end">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Periodo</label>
                            <select id="analyticsPeriod" class="w-full rounded-lg border-gray-300 shadow-sm p-2.5 border">
                                <option value="day">Día</option>
                                <option value="week" selected>Semana</option>
                                <option value="month">Mes</option>
                                <option value="year">Año</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        
                        <!-- Selector de día específico -->
                        <div id="analyticsDayContainer" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Seleccionar día</label>
                            <input type="date" id="analyticsDayPicker" class="w-full rounded-lg border-gray-300 shadow-sm p-2.5 border">
                        </div>
                        
                        <!-- Selector de semana -->
                        <div id="analyticsWeekContainer" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Seleccionar semana</label>
                            <input type="week" id="analyticsWeekPicker" class="w-full rounded-lg border-gray-300 shadow-sm p-2.5 border">
                        </div>
                        
                        <!-- Selector de mes -->
                        <div id="analyticsMonthContainer" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Seleccionar mes</label>
                            <input type="month" id="analyticsMonthPicker" class="w-full rounded-lg border-gray-300 shadow-sm p-2.5 border">
                        </div>
                        
                        <!-- Selector de año -->
                        <div id="analyticsYearContainer" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Seleccionar año</label>
                            <select id="analyticsYearPicker" class="w-full rounded-lg border-gray-300 shadow-sm p-2.5 border">
                            </select>
                        </div>
                        
                        <!-- Rango personalizado -->
                        <div id="analyticsCustomDateContainer" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Fecha inicio</label>
                            <input type="date" id="analyticsStartDate" class="w-full rounded-lg border-gray-300 shadow-sm p-2.5 border">
                        </div>
                        
                        <div id="analyticsCustomDateContainer2" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Fecha fin</label>
                            <input type="date" id="analyticsEndDate" class="w-full rounded-lg border-gray-300 shadow-sm p-2.5 border">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Top N números</label>
                            <select id="analyticsTopN" class="w-full rounded-lg border-gray-300 shadow-sm p-2.5 border">
                                <option value="10">Top 10</option>
                                <option value="20">Top 20</option>
                                <option value="50">Top 50</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Acciones</label>
                            <div class="flex gap-2">
                                <button onclick="refreshAnalytics()" class="px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 transition-colors">🔄</button>
                                <button onclick="exportAnalyticsCSV()" class="px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors">📥</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <div class="text-sm">
                            <span class="font-semibold">Período:</span> 
                            <span id="analyticsCurrentPeriodInfo">Hoy</span>
                            <span class="ml-4 text-gray-400">|</span>
                            <span class="ml-4">Estado: <span id="analyticsStatusBadge" class="px-2 py-1 text-xs rounded-full bg-gray-200">Cargando...</span></span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white rounded-lg shadow p-5">
                        <div class="text-3xl font-semibold" id="analytics_kpi_total">—</div>
                        <div class="text-sm text-gray-500">Total registros</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-5">
                        <div class="text-3xl font-semibold text-green-600" id="analytics_kpi_enviados">—</div>
                        <div class="text-sm text-gray-500">Enviados</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-5">
                        <div class="text-3xl font-semibold text-red-600" id="analytics_kpi_errores">—</div>
                        <div class="text-sm text-gray-500">Errores</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-5">
                        <div class="text-3xl font-semibold text-yellow-600" id="analytics_kpi_cola">—</div>
                        <div class="text-sm text-gray-500">En cola</div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">Estado de Sesiones</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-sm text-gray-500 mb-1">Sesión Actual</div>
                            <div class="font-mono text-lg" id="analyticsCurrentSession">—</div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-sm text-gray-500 mb-1">Progreso de Mensajes</div>
                            <div class="font-mono text-lg" id="analyticsSessionProgress">—</div>
                            <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" id="analyticsProgressBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-sm text-gray-500 mb-1">Sesiones Disponibles</div>
                            <div class="font-mono text-sm" id="analyticsAvailableSessions">—</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">Evolución por periodo</h3>
                    <div class="w-full" style="height: 350px;">
                        <canvas id="analyticsTimelineChart"></canvas>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Top N números</h3>
                        <div class="flex items-center gap-2">
                            <label class="text-sm text-gray-600">Mostrar:</label>
                            <select id="analyticsTopNChart" class="rounded-lg border-gray-300 shadow-sm p-2 border text-sm">
                                <option value="5">Top 5</option>
                                <option value="10" selected>Top 10</option>
                                <option value="15">Top 15</option>
                                <option value="20">Top 20</option>
                                <option value="30">Top 30</option>
                                <option value="50">Top 50</option>
                            </select>
                            <span class="text-xs text-gray-500 ml-2">💡 Haz clic en una barra para ver detalles</span>
                        </div>
                    </div>
                    <div class="w-full" style="height: 300px;">
                        <canvas id="analyticsTopChart"></canvas>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Detalle de Mensajes <span id="analyticsDetailTitle" class="text-purple-600 font-normal"></span></h3>
                        <button onclick="clearAnalyticsFilter()" id="analyticsClearFilterBtn" class="hidden px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg">✖ Quitar filtro</button>
                    </div>
                    <div class="overflow-auto max-h-96">
                        <table class="min-w-full text-sm" id="analyticsTopTable">
                            <thead class="border-b border-gray-200 sticky top-0 bg-white">
                                <tr class="text-left">
                                    <th class="py-2 pr-4">#</th>
                                    <th class="py-2 pr-4 cursor-pointer hover:bg-gray-50 select-none" onclick="sortAnalyticsTable('phone_number')">
                                        Número <span id="analyticsSort_phone_number" class="text-xs">↕</span>
                                    </th>
                                    <th class="py-2 pr-4 cursor-pointer hover:bg-gray-50 select-none" onclick="sortAnalyticsTable('total')">
                                        Total <span id="analyticsSort_total" class="text-xs">↕</span>
                                    </th>
                                    <th class="py-2 pr-4 cursor-pointer hover:bg-gray-50 select-none" onclick="sortAnalyticsTable('enviados')">
                                        Enviados <span id="analyticsSort_enviados" class="text-xs">↕</span>
                                    </th>
                                    <th class="py-2 pr-4 cursor-pointer hover:bg-gray-50 select-none" onclick="sortAnalyticsTable('errores')">
                                        Errores <span id="analyticsSort_errores" class="text-xs">↕</span>
                                    </th>
                                    <th class="py-2 pr-4 cursor-pointer hover:bg-gray-50 select-none" onclick="sortAnalyticsTable('en_cola')">
                                        En cola <span id="analyticsSort_en_cola" class="text-xs">↕</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="analyticsTopTableBody">
                                <tr>
                                    <td colspan="7" class="py-4 text-center text-gray-500">Cargando datos...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="analyticsSelectedMessagesSection" class="bg-white rounded-lg shadow p-6 mt-6 hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Mensajes del número <span id="analyticsSelectedPhoneTitle" class="text-purple-600 font-normal"></span></h3>
                    </div>
                    <div class="overflow-auto max-h-96">
                        <table class="min-w-full text-sm">
                            <thead class="border-b border-gray-200 sticky top-0 bg-white">
                                <tr class="text-left">
                                    <th class="py-2 pr-4">#</th>
                                    <th class="py-2 pr-4">Fecha/Hora</th>
                                    <th class="py-2 pr-4">Sesión</th>
                                    <th class="py-2 pr-4">Mensaje</th>
                                    <th class="py-2 pr-4">Estado</th>
                                </tr>
                            </thead>
                            <tbody id="analyticsSelectedMessagesBody">
                                <tr>
                                    <td colspan="5" class="py-4 text-center text-gray-500">Selecciona un número</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="analyticsSelectedMessagesPagination" class="flex gap-2 justify-end mt-4"></div>
                </div>

                <div class="text-xs text-gray-500 mt-6 space-y-1">
                    <div>DB size (MB): <span id="analyticsDbSize">-</span></div>
                    <div>Estados en DB: <span id="analyticsDbByStatus">-</span></div>
                    <div>Última actualización: <span id="analyticsLastUpdate">-</span></div>
                </div>
            </section>

            <!-- SECTION: CONVERSACIÓN IA (Anti-Ban) -->
            <section id="section-conversation" class="section-content">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">🤖</span>
                            <div>
                                <h3 class="text-lg font-semibold">Conversación IA Anti-Ban</h3>
                                <p class="text-sm text-gray-500">Las sesiones conversan entre sí usando ChatGPT para simular actividad natural</p>
                            </div>
                        </div>
                        
                        <!-- Saldo OpenAI -->
                        <div id="openaiBalance" class="text-right">
                            <button onclick="loadOpenAIBalance()" class="text-xs bg-green-100 text-green-700 px-3 py-1 rounded-lg hover:bg-green-200 flex items-center gap-1">
                                <span>🔄</span>
                                <span>Ver estado API</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Info OpenAI Balance -->
                    <div id="openaiBalanceInfo" class="hidden bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
                        <div class="flex items-start gap-2">
                            <span class="text-green-600">✓</span>
                            <div class="text-sm text-green-800 flex-1" id="openaiBalanceContent">
                                Cargando información...
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                        <div class="flex items-start gap-2">
                            <span class="text-yellow-600">⚠️</span>
                            <div class="text-sm text-yellow-800">
                                <strong>¿Cómo funciona?</strong><br>
                                Selecciona dos o más sesiones activas. Una iniciará la conversación con el tema que escribas, 
                                y las demás responderán automáticamente usando IA. Esto genera actividad natural en las cuentas.
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sesiones para conversar (mínimo 2)</label>
                                <div id="conversationSessionCheckboxes" class="border rounded-lg p-3 max-h-40 overflow-y-auto bg-gray-50">
                                    <p class="text-gray-500 text-sm">Cargando sesiones...</p>
                                </div>
                                <div class="flex gap-2 mt-2">
                                    <button onclick="selectAllConversationSessions()" class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded hover:bg-purple-200">Seleccionar todas</button>
                                    <button onclick="deselectAllConversationSessions()" class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-gray-200">Deseleccionar</button>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tema inicial de conversación</label>
                                <textarea id="conversationTopic" placeholder="Ej: Hola, ¿cómo estás? ¿Qué planes tienes para hoy?" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none h-24"></textarea>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Mensajes por sesión</label>
                                <div class="flex items-center gap-4">
                                    <input type="range" id="conversationMessageCount" min="2" max="20" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                    <span id="conversationMessageCountValue" class="text-2xl font-bold text-purple-600 w-12 text-center">5</span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Total de mensajes que enviará cada sesión en la conversación</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Delay entre mensajes (segundos)</label>
                                <div class="flex items-center gap-4">
                                    <input type="range" id="conversationDelay" min="5" max="60" value="15" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                    <span id="conversationDelayValue" class="text-xl font-bold text-purple-600 w-16 text-center">15s</span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Tiempo de espera entre cada mensaje para parecer natural</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Estilo de conversación</label>
                                <select id="conversationStyle" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
                                    <option value="casual">😊 Casual y amigable</option>
                                    <option value="formal">👔 Formal y profesional</option>
                                    <option value="funny">😂 Gracioso y divertido</option>
                                    <option value="short">💬 Respuestas cortas</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex gap-4">
                        <button onclick="startAIConversation()" id="startConversationBtn" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors font-semibold flex items-center gap-2">
                            🚀 Iniciar Conversación
                        </button>
                        <button onclick="stopAIConversation()" id="stopConversationBtn" class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 transition-colors font-semibold hidden">
                            ⏹️ Detener
                        </button>
                    </div>
                    
                    <div id="conversationStatus" class="mt-4"></div>
                </div>
                
                <!-- Log de conversación -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">📝 Log de Conversación</h3>
                        <button onclick="clearConversationLog()" class="bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-lg text-sm transition-colors">🗑️ Limpiar</button>
                    </div>
                    <div id="conversationLog" class="bg-gray-900 rounded-lg p-4 h-80 overflow-y-auto font-mono text-sm">
                        <p class="text-gray-500">Esperando inicio de conversación...</p>
                    </div>
                </div>
            </section>

            <!-- SETTINGS SECTION -->
            <section id="section-settings" class="section-content space-y-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">⏱️ Configuración de Consolidación de Mensajes</h3>
                    <p class="text-gray-600 mb-6">
                        Los mensajes del mismo número se agrupan y se envían juntos después del tiempo configurado.
                        Esto evita baneos y reduce la cantidad de mensajes enviados.
                    </p>
                    
                    <div class="max-w-md">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Tiempo de espera para consolidar (minutos)
                        </label>
                        <div class="flex items-center gap-4">
                            <input type="range" id="batchIntervalRange" min="1" max="10" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <span id="batchIntervalValue" class="text-2xl font-bold text-green-600 w-12 text-center">3</span>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>1 min (Rápido)</span>
                            <span>10 min (Seguro)</span>
                        </div>
                        
                        <button onclick="saveBatchSettings()" class="mt-6 bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition-colors w-full">
                            Guardar Configuración
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">Configuración de Notificaciones</h3>
                    <p class="text-gray-600 mb-6">
                        Configura cada cuánto tiempo recibirás reportes del estado de las sesiones.
                    </p>
                    
                    <div class="max-w-md">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Intervalo de notificaciones (minutos)
                        </label>
                        <div class="flex items-center gap-4 mb-4">
                            <button onclick="setNotificationInterval(1)" id="notif-1" class="notification-interval-btn flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition-colors">
                                1 min
                            </button>
                            <button onclick="setNotificationInterval(5)" id="notif-5" class="notification-interval-btn flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition-colors">
                                5 min
                            </button>
                            <button onclick="setNotificationInterval(30)" id="notif-30" class="notification-interval-btn flex-1 px-4 py-2 border-2 border-blue-500 bg-blue-50 rounded-lg">
                                30 min
                            </button>
                            <button onclick="setNotificationInterval(60)" id="notif-60" class="notification-interval-btn flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition-colors">
                                60 min
                            </button>
                        </div>
                        
                        <button onclick="saveNotificationSettings()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors w-full">
                            Guardar Configuración
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">⏱️ Tiempo de Sesión</h3>
                    <p class="text-gray-600 mb-6">
                        Configura el tiempo máximo de actividad de cada sesión antes de requerir reconexión.
                    </p>
                    
                    <div class="max-w-md">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Duración de sesión (minutos)
                        </label>
                        <div class="flex items-center gap-4 mb-4">
                            <button onclick="setSessionTimeout(5)" id="timeout-5" class="session-timeout-btn flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg hover:border-green-500 transition-colors">
                                5 min
                            </button>
                            <button onclick="setSessionTimeout(10)" id="timeout-10" class="session-timeout-btn flex-1 px-4 py-2 border-2 border-green-500 bg-green-50 rounded-lg">
                                10 min
                            </button>
                            <button onclick="setSessionTimeout(20)" id="timeout-20" class="session-timeout-btn flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg hover:border-green-500 transition-colors">
                                20 min
                            </button>
                            <button onclick="setSessionTimeout(30)" id="timeout-30" class="session-timeout-btn flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg hover:border-green-500 transition-colors">
                                30 min
                            </button>
                        </div>
                        
                        <button onclick="saveSessionTimeoutSettings()" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition-colors w-full">
                            Guardar Configuración
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">Estado de la Cola</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                            <div class="text-sm text-blue-600 mb-1">Mensajes en Cola</div>
                            <div id="queueSize" class="text-2xl font-bold text-blue-800">0</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg border border-purple-100">
                            <div class="text-sm text-purple-600 mb-1">Números Pendientes</div>
                            <div id="pendingNumbers" class="text-2xl font-bold text-purple-800">0</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg border border-green-100">
                            <div class="text-sm text-green-600 mb-1">Intervalo Actual</div>
                            <div id="currentInterval" class="text-2xl font-bold text-green-800">3 min</div>
                        </div>
                    </div>
                    <button onclick="refreshBatchStatus()" class="mt-4 text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1">
                        🔄 Actualizar estado
                    </button>
                </div>
            </section>

            <!-- ======================== SECCIÓN: BASE DE DATOS ======================== -->
            <section id="section-database" class="section-content space-y-6">
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-xl font-semibold mb-4">🗄️ Estado de la Base de Datos PostgreSQL</h2>
                    
                    <!-- Estado de Conexión -->
                    <div id="dbStatusCard" class="bg-gray-50 rounded-lg p-4 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-semibold">Estado de Conexión</h3>
                                <p class="text-sm text-gray-600">PostgreSQL Database</p>
                            </div>
                            <button onclick="refreshDatabaseStatus()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors text-sm">
                                🔄 Actualizar
                            </button>
                        </div>
                        
                        <div id="dbStatusContent" class="space-y-3">
                            <div class="flex items-center justify-center py-8">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Información de Tablas -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold mb-4">📊 Tablas y Registros</h3>
                        <div id="dbTablesContent" class="overflow-x-auto">
                            <div class="text-center text-gray-500 py-4">Cargando información...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ======================== SECCIÓN: CENTRO DE MENSAJES ======================== -->
            <section id="section-webhooks" class="section-content">
                <div class="bg-white rounded-lg shadow-sm overflow-hidden" style="height: calc(100vh - 180px);">
                    <iframe id="webhooksIframe" src="webhook-viewer.html" class="w-full h-full border-0"></iframe>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal: mensaje completo de busqueda -->
    <div id="searchMessageModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4">
            <div class="flex items-center justify-between px-5 py-3 border-b">
                <h3 class="text-lg font-semibold text-gray-800">Mensaje completo</h3>
                <button onclick="closeSearchMessageModal()" class="text-gray-500 hover:text-gray-700" aria-label="Cerrar">✕</button>
            </div>
            <div class="px-5 py-4">
                <div id="searchMessageModalBody" class="text-gray-700 whitespace-pre-wrap break-words"></div>
            </div>
            <div class="px-5 py-3 border-t flex justify-end">
                <button onclick="closeSearchMessageModal()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Scripts externos -->
    <script src="js/auth.js?v=5"></script>
    <script src="js/app.js?v=5"></script>
    <script src="js/analytics.js?v=5"></script>
    <script src="js/database.js?v=5"></script>
</body>
</html>
