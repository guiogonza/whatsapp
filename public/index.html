<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Bot - Panel de Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ========================================
           ESTILOS PERSONALIZADOS
           ======================================== */
        
        /* Animaci√≥n de carga */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #25D366;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Estilos del sidebar */
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        
        .sidebar-item {
            transition: all 0.2s ease;
        }
        
        .sidebar-item:hover {
            background-color: rgba(37, 211, 102, 0.1);
        }
        
        .sidebar-item.active {
            background-color: rgba(37, 211, 102, 0.2);
            border-left: 4px solid #25D366;
        }
        
        /* Ocultar secciones */
        .section-content {
            display: none;
        }
        
        .section-content.active {
            display: block;
        }
        
        /* Pantalla de login */
        #loginScreen {
            background: linear-gradient(135deg, #128C7E 0%, #25D366 100%);
        }
        
        /* Estilos de cards de sesi√≥n */
        .session-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .session-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
    </style>
    
    <script>
        /* ========================================
           VARIABLES GLOBALES
           ======================================== */
        const CREDENTIALS = {
            username: 'admin',
            password: 'guio123*'
        };
        
        const SESSION_TIMEOUT = 5 * 60 * 1000; // 5 minutos
        let sessionTimer = null;
        let timerInterval = null;
        let timeRemaining = SESSION_TIMEOUT;
        
        /* ========================================
           FUNCIONES DE AUTENTICACI√ìN
           ======================================== */
        
        /**
         * Verifica las credenciales del usuario
         */
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('loginError');
            
            if (username === CREDENTIALS.username && password === CREDENTIALS.password) {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                startSessionTimer();
                loadSessions();
            } else {
                errorEl.textContent = 'Usuario o contrase√±a incorrectos';
                errorEl.classList.remove('hidden');
            }
        }
        
        /**
         * Cierra la sesi√≥n del usuario
         */
        function logout() {
            clearTimeout(sessionTimer);
            clearInterval(timerInterval);
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').classList.add('hidden');
        }
        
        /**
         * Inicia el temporizador de sesi√≥n
         */
        function startSessionTimer() {
            timeRemaining = SESSION_TIMEOUT;
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                timeRemaining -= 1000;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    logout();
                    alert('Sesi√≥n expirada por inactividad');
                }
            }, 1000);
        }
        
        /**
         * Actualiza el display del temporizador
         */
        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60000);
            const seconds = Math.floor((timeRemaining % 60000) / 1000);
            const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('sessionTimer').textContent = display;
        }
        
        /**
         * Reinicia el temporizador de inactividad
         */
        function resetTimer() {
            timeRemaining = SESSION_TIMEOUT;
        }
        
        // Detectar actividad del usuario
        document.addEventListener('click', resetTimer);
        document.addEventListener('keypress', resetTimer);
    </script>
</head>
<body class="bg-gray-100 min-h-screen">
    
    <!-- ========================================
         PANTALLA DE LOGIN
         ======================================== -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">üì±</div>
                <h1 class="text-2xl font-bold text-gray-800">WhatsApp Bot</h1>
                <p class="text-gray-500">Panel de Control</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
                    <input type="text" id="username" 
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none"
                           placeholder="Ingresa tu usuario"
                           onkeypress="if(event.key==='Enter') login()">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Contrase√±a</label>
                    <input type="password" id="password" 
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none"
                           placeholder="Ingresa tu contrase√±a"
                           onkeypress="if(event.key==='Enter') login()">
                </div>
                
                <div id="loginError" class="text-red-500 text-sm text-center hidden"></div>
                
                <button onclick="login()" 
                        class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors">
                    Iniciar Sesi√≥n
                </button>
            </div>
        </div>
    </div>
    
    <!-- ========================================
         APLICACI√ìN PRINCIPAL
         ======================================== -->
    <div id="mainApp" class="hidden flex min-h-screen">
        
        <!-- ========================================
             SIDEBAR
             ======================================== -->
        <aside class="sidebar w-64 bg-white shadow-lg fixed h-full z-10">
            <!-- Logo y t√≠tulo -->
            <div class="p-6 border-b bg-gradient-to-r from-green-500 to-green-600">
                <div class="flex items-center space-x-3">
                    <span class="text-3xl">üì±</span>
                    <div>
                        <h1 class="text-white font-bold text-lg">WhatsApp Bot</h1>
                        <p class="text-green-100 text-xs">Panel de Control</p>
                    </div>
                </div>
            </div>
            
            <!-- Navegaci√≥n -->
            <nav class="p-4">
                <ul class="space-y-2">
                    <li>
                        <button onclick="showSection('sessions')" 
                                id="nav-sessions"
                                class="sidebar-item active w-full text-left px-4 py-3 rounded-lg flex items-center space-x-3">
                            <span class="text-xl">üîó</span>
                            <span class="font-medium">Sesiones</span>
                        </button>
                    </li>
                    <li>
                        <button onclick="showSection('personal')" 
                                id="nav-personal"
                                class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center space-x-3">
                            <span class="text-xl">üí¨</span>
                            <span class="font-medium">Mensaje Personal</span>
                        </button>
                    </li>
                    <li>
                        <button onclick="showSection('bulk')" 
                                id="nav-bulk"
                                class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center space-x-3">
                            <span class="text-xl">üì§</span>
                            <span class="font-medium">Env√≠o Masivo</span>
                        </button>
                    </li>
                </ul>
            </nav>
            
            <!-- Info de sesi√≥n -->
            <div class="absolute bottom-0 left-0 right-0 p-4 border-t bg-gray-50">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-sm text-gray-600">‚è±Ô∏è Sesi√≥n:</span>
                    <span id="sessionTimer" class="font-mono text-green-600 font-bold">5:00</span>
                </div>
                <button onclick="logout()" 
                        class="w-full bg-red-500 text-white py-2 rounded-lg text-sm hover:bg-red-600 transition-colors">
                    üö™ Cerrar Sesi√≥n
                </button>
            </div>
        </aside>
        
        <!-- ========================================
             CONTENIDO PRINCIPAL
             ======================================== -->
        <main class="flex-1 ml-64 p-6">
            
            <!-- Header -->
            <header class="bg-white rounded-lg shadow p-4 mb-6 flex justify-between items-center">
                <div>
                    <h2 id="sectionTitle" class="text-xl font-bold text-gray-800">Sesiones de WhatsApp</h2>
                    <p id="sectionSubtitle" class="text-sm text-gray-500">Gestiona tus conexiones de WhatsApp</p>
                </div>
                <div id="activeSessionsCount" class="text-sm text-gray-600"></div>
            </header>
            
            <!-- ========================================
                 SECCI√ìN: SESIONES
                 ======================================== -->
            <section id="section-sessions" class="section-content active">
                
                <!-- Crear nueva sesi√≥n -->
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">‚ûï Crear Nueva Sesi√≥n</h3>
                    <div class="flex gap-4">
                        <input type="text" id="sessionName" 
                               placeholder="Nombre de la sesi√≥n (ej: MiEmpresa)"
                               class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none">
                        <button onclick="createSession()" id="createSessionBtn"
                                class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition-colors">
                            Crear Sesi√≥n
                        </button>
                    </div>
                    <p id="createSessionStatus" class="mt-2 text-sm"></p>
                </div>
                
                <!-- Lista de sesiones -->
                <div id="sessionsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="col-span-full text-center p-8">
                        <div class="spinner mx-auto mb-4"></div>
                        <p class="text-gray-600">Cargando sesiones...</p>
                    </div>
                </div>
            </section>
            
            <!-- ========================================
                 SECCI√ìN: MENSAJE PERSONALIZADO
                 ======================================== -->
            <section id="section-personal" class="section-content">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">üí¨ Enviar Mensaje Personalizado</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Columna izquierda -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sesiones (selecciona una o varias)</label>
                                <div id="personalSessionCheckboxes" class="border rounded-lg p-3 max-h-32 overflow-y-auto bg-gray-50">
                                    <p class="text-gray-500 text-sm">Cargando sesiones...</p>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">El mensaje se enviar√° desde todas las sesiones seleccionadas</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">N√∫mero de Tel√©fono</label>
                                <input type="text" id="personalPhone" 
                                       placeholder="573196319531"
                                       class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                <p class="text-xs text-gray-500 mt-1">Formato: c√≥digo de pa√≠s + n√∫mero</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Archivo (opcional)</label>
                                <input type="file" id="personalFile" 
                                       accept="image/*,video/*,audio/*,.pdf,.doc,.docx"
                                       class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            </div>
                        </div>
                        
                        <!-- Columna derecha -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Mensaje</label>
                                <textarea id="personalMessage" 
                                          placeholder="Escribe tu mensaje aqu√≠..."
                                          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none h-32"></textarea>
                            </div>
                            
                            <button onclick="sendPersonalMessage()" id="sendPersonalBtn"
                                    class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition-colors font-semibold">
                                üì® Enviar Mensaje
                            </button>
                            
                            <div id="personalStatus" class="text-sm"></div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- ========================================
                 SECCI√ìN: ENV√çO MASIVO
                 ======================================== -->
            <section id="section-bulk" class="section-content">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">üì§ Env√≠o Masivo de Mensajes</h3>
                    
                    <!-- Selector de sesiones m√∫ltiples -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sesiones de WhatsApp (selecciona una o varias)</label>
                        <div id="bulkSessionCheckboxes" class="border rounded-lg p-3 max-h-32 overflow-y-auto bg-gray-50">
                            <p class="text-gray-500 text-sm">Cargando sesiones...</p>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <button onclick="selectAllBulkSessions()" class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded hover:bg-purple-200">Seleccionar todas</button>
                            <button onclick="deselectAllBulkSessions()" class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-gray-200">Deseleccionar todas</button>
                        </div>
                    </div>
                    
                    <!-- Tabs -->
                    <div class="mb-4 border-b">
                        <div class="flex">
                            <button id="tabNumbers" onclick="switchBulkTab('numbers')"
                                    class="px-4 py-2 border-b-2 border-purple-500 text-purple-600 font-medium">
                                üì± N√∫meros de Tel√©fono
                            </button>
                            <button id="tabGroups" onclick="switchBulkTab('groups')"
                                    class="px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                                üë• Grupos de WhatsApp
                            </button>
                        </div>
                    </div>
                    
                    <!-- Panel de N√∫meros -->
                    <div id="panelNumbers" class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lista de N√∫meros (uno por l√≠nea)</label>
                        <textarea id="bulkContacts" 
                                  placeholder="573196319531&#10;573123456789&#10;573987654321"
                                  class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none h-32"></textarea>
                        <p class="text-xs text-gray-500 mt-1">Formato: c√≥digo pa√≠s + n√∫mero. Un n√∫mero por l√≠nea. M√°ximo 50.</p>
                    </div>
                    
                    <!-- Panel de Grupos -->
                    <div id="panelGroups" class="mb-4 hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Seleccionar Grupos</label>
                        <div id="groupsList" class="border rounded-lg p-3 max-h-48 overflow-y-auto bg-gray-50">
                            <p class="text-gray-500 text-sm">Selecciona una sesi√≥n para ver los grupos</p>
                        </div>
                    </div>
                    
                    <!-- Mensaje y archivo -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mensaje</label>
                            <textarea id="bulkMessage" 
                                      placeholder="Mensaje para env√≠o masivo..."
                                      class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none h-24"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Archivo (opcional)</label>
                            <input type="file" id="bulkFileInput" 
                                   accept="image/*,video/*,audio/*,.pdf,.doc,.docx"
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
                            <div class="mt-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Delay (segundos)</label>
                                <input type="number" id="bulkDelay" value="3" min="1" max="10"
                                       class="w-20 px-2 py-1 border rounded-lg">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botones -->
                    <div class="flex gap-4 flex-wrap">
                        <button onclick="sendBulkMessages()" id="sendBulkBtn"
                                class="bg-purple-500 text-white px-6 py-2 rounded-lg hover:bg-purple-600 transition-colors">
                            üöÄ Enviar Masivo
                        </button>
                        <button onclick="loadGroups()"
                                class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                            üîÑ Recargar Grupos
                        </button>
                        <button onclick="clearBulkForm()"
                                class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            üóëÔ∏è Limpiar
                        </button>
                    </div>
                    
                    <!-- Status y progreso -->
                    <div id="bulkStatus" class="mt-4 text-sm"></div>
                    <div id="bulkProgress" class="mt-2 hidden">
                        <div class="bg-gray-200 rounded-full h-2">
                            <div id="bulkProgressBar" class="bg-purple-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                        <p id="bulkProgressText" class="text-xs text-gray-600 mt-1"></p>
                    </div>
                </div>
            </section>
            
        </main>
    </div>
    
    <!-- ========================================
         JAVASCRIPT PRINCIPAL
         ======================================== -->
    <script>
        /* ========================================
           VARIABLES GLOBALES
           ======================================== */
        const API_URL = window.location.origin;
        let sessions = [];
        let bulkCurrentTab = 'numbers';
        let bulkSelectedFile = null;
        
        /* ========================================
           FUNCIONES DE NAVEGACI√ìN
           ======================================== */
        
        /**
         * Muestra una secci√≥n espec√≠fica del panel
         * @param {string} sectionId - ID de la secci√≥n a mostrar
         */
        function showSection(sectionId) {
            // Ocultar todas las secciones
            document.querySelectorAll('.section-content').forEach(section => {
                section.classList.remove('active');
            });
            
            // Desactivar todos los items del sidebar
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Mostrar secci√≥n seleccionada
            document.getElementById(`section-${sectionId}`).classList.add('active');
            document.getElementById(`nav-${sectionId}`).classList.add('active');
            
            // Actualizar t√≠tulo
            const titles = {
                sessions: { title: 'Sesiones de WhatsApp', subtitle: 'Gestiona tus conexiones de WhatsApp' },
                personal: { title: 'Mensaje Personalizado', subtitle: 'Env√≠a mensajes individuales' },
                bulk: { title: 'Env√≠o Masivo', subtitle: 'Env√≠a mensajes a m√∫ltiples destinatarios' }
            };
            
            document.getElementById('sectionTitle').textContent = titles[sectionId].title;
            document.getElementById('sectionSubtitle').textContent = titles[sectionId].subtitle;
        }
        
        /* ========================================
           FUNCIONES DE SESIONES
           ======================================== */
        
        /**
         * Carga las sesiones desde el servidor
         */
        async function loadSessions() {
            try {
                const response = await fetch(`${API_URL}/api/sessions`);
                sessions = await response.json();
                
                updateSessionsList();
                populateSessionSelects();
                updateSessionsCount();
                
            } catch (error) {
                console.error('Error cargando sesiones:', error);
                document.getElementById('sessionsList').innerHTML = `
                    <div class="col-span-full bg-red-50 border border-red-200 p-6 rounded-lg text-center">
                        <p class="text-red-600">Error al cargar sesiones: ${error.message}</p>
                        <button onclick="loadSessions()" class="mt-2 bg-red-500 text-white px-4 py-2 rounded-lg">
                            Reintentar
                        </button>
                    </div>
                `;
            }
        }
        
        /**
         * Actualiza la lista visual de sesiones
         */
        function updateSessionsList() {
            const container = document.getElementById('sessionsList');
            
            if (sessions.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center p-8 bg-white rounded-lg shadow">
                        <div class="text-6xl mb-4">üì±</div>
                        <p class="text-gray-600 mb-2">No hay sesiones activas</p>
                        <p class="text-gray-500 text-sm">Crea una nueva sesi√≥n para comenzar</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = sessions.map(session => createSessionCard(session)).join('');
            
            // Cargar QR codes si es necesario
            sessions.forEach(session => {
                if (session.state === 'WAITING_FOR_QR' && session.hasQR) {
                    loadQRCode(session.name);
                }
            });
        }
        
        /**
         * Crea el HTML de una tarjeta de sesi√≥n
         * @param {Object} session - Datos de la sesi√≥n
         * @returns {string} HTML de la tarjeta
         */
        function createSessionCard(session) {
            const stateColors = {
                'READY': 'border-green-500 bg-green-50',
                'WAITING_FOR_QR': 'border-yellow-500 bg-yellow-50',
                'LOADING': 'border-blue-500 bg-blue-50',
                'DISCONNECTED': 'border-red-500 bg-red-50',
                'ERROR': 'border-red-500 bg-red-50'
            };
            
            const stateLabels = {
                'READY': '‚úÖ Conectado',
                'WAITING_FOR_QR': 'üì± Esperando QR',
                'LOADING': '‚è≥ Cargando',
                'DISCONNECTED': '‚ùå Desconectado',
                'ERROR': '‚ö†Ô∏è Error'
            };
            
            const colorClass = stateColors[session.state] || 'border-gray-500 bg-gray-50';
            const stateLabel = stateLabels[session.state] || session.state;
            
            // Informaci√≥n del usuario conectado
            let userInfoHtml = '';
            if (session.userInfo && session.state === 'READY') {
                userInfoHtml = `
                    <div class="mt-3 p-3 bg-white rounded-lg border">
                        <p class="text-sm"><strong>üë§ Nombre:</strong> ${session.userInfo.pushname || 'N/A'}</p>
                        <p class="text-sm"><strong>üìû N√∫mero:</strong> ${session.userInfo.wid || 'N/A'}</p>
                        <p class="text-sm"><strong>üì± Plataforma:</strong> ${session.userInfo.platform || 'N/A'}</p>
                    </div>
                `;
            }
            
            // QR container
            let qrHtml = '';
            if (session.state === 'WAITING_FOR_QR') {
                qrHtml = `
                    <div id="qr-container-${session.name}" class="mt-3 flex justify-center">
                        <div class="spinner"></div>
                    </div>
                `;
            }
            
            return `
                <div class="session-card bg-white rounded-lg shadow-lg overflow-hidden">
                    <div class="border-l-4 ${colorClass} p-6">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="text-lg font-bold">${session.name}</h3>
                                <span class="text-sm">${stateLabel}</span>
                            </div>
                            <button onclick="deleteSession('${session.name}')" 
                                    class="text-red-500 hover:text-red-700 p-1">
                                üóëÔ∏è
                            </button>
                        </div>
                        
                        ${userInfoHtml}
                        ${qrHtml}
                        
                        <div class="mt-3 text-xs text-gray-500">
                            <p>üìä Mensajes: ${session.messageCount || 0}</p>
                            <p>üïê √öltima actividad: ${session.lastActivity ? new Date(session.lastActivity).toLocaleString() : 'N/A'}</p>
                        </div>
                        
                        <div class="mt-4 flex gap-2">
                            ${session.state === 'DISCONNECTED' || session.state === 'ERROR' ? `
                                <button onclick="reconnectSession('${session.name}')" 
                                        class="flex-1 bg-blue-500 text-white py-2 rounded text-sm hover:bg-blue-600">
                                    üîÑ Reconectar
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        /**
         * Carga el c√≥digo QR de una sesi√≥n
         * @param {string} sessionName - Nombre de la sesi√≥n
         */
        async function loadQRCode(sessionName) {
            const container = document.getElementById(`qr-container-${sessionName}`);
            if (!container) return;
            
            try {
                const response = await fetch(`${API_URL}/api/session/${sessionName}/qr`);
                
                if (response.ok) {
                    // El endpoint devuelve el QR como texto (data URL)
                    const qrDataUrl = await response.text();
                    if (qrDataUrl && qrDataUrl.startsWith('data:image')) {
                        container.innerHTML = `<img src="${qrDataUrl}" alt="QR Code" class="w-48 h-48 mx-auto">`;
                    } else {
                        container.innerHTML = `<p class="text-gray-500 text-sm">Esperando c√≥digo QR...</p>`;
                    }
                } else {
                    container.innerHTML = `<p class="text-gray-500 text-sm">QR no disponible a√∫n</p>`;
                }
            } catch (error) {
                console.error('Error cargando QR:', error);
                container.innerHTML = `<p class="text-red-500 text-sm">Error al cargar QR</p>`;
            }
        }
        
        /**
         * Crea una nueva sesi√≥n
         */
        async function createSession() {
            const nameInput = document.getElementById('sessionName');
            const sessionName = nameInput.value.trim();
            const statusEl = document.getElementById('createSessionStatus');
            const button = document.getElementById('createSessionBtn');
            
            if (!sessionName) {
                statusEl.className = 'mt-2 text-sm text-red-500';
                statusEl.textContent = 'Por favor ingresa un nombre para la sesi√≥n';
                return;
            }
            
            if (!/^[a-zA-Z0-9_-]+$/.test(sessionName)) {
                statusEl.className = 'mt-2 text-sm text-red-500';
                statusEl.textContent = 'Nombre inv√°lido. Solo letras, n√∫meros, guiones.';
                return;
            }
            
            button.disabled = true;
            button.innerHTML = '<span class="spinner inline-block mr-2"></span> Creando...';
            
            try {
                const response = await fetch(`${API_URL}/api/sessions/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionName })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusEl.className = 'mt-2 text-sm text-green-500';
                    statusEl.textContent = '‚úÖ Sesi√≥n creada. Escanea el c√≥digo QR.';
                    nameInput.value = '';
                    // Esperar m√°s tiempo y recargar peri√≥dicamente para mostrar QR
                    setTimeout(loadSessions, 1000);
                    setTimeout(loadSessions, 3000);
                    setTimeout(loadSessions, 6000);
                } else {
                    statusEl.className = 'mt-2 text-sm text-red-500';
                    statusEl.textContent = `‚ùå Error: ${result.error}`;
                }
            } catch (error) {
                statusEl.className = 'mt-2 text-sm text-red-500';
                statusEl.textContent = `‚ùå Error: ${error.message}`;
            } finally {
                button.disabled = false;
                button.textContent = 'Crear Sesi√≥n';
            }
        }
        
        /**
         * Elimina una sesi√≥n
         * @param {string} sessionName - Nombre de la sesi√≥n
         */
        async function deleteSession(sessionName) {
            if (!confirm(`¬øEliminar la sesi√≥n "${sessionName}"?`)) return;
            
            try {
                const response = await fetch(`${API_URL}/api/session/delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionName })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    loadSessions();
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        /**
         * Reconecta una sesi√≥n
         * @param {string} sessionName - Nombre de la sesi√≥n
         */
        async function reconnectSession(sessionName) {
            try {
                const response = await fetch(`${API_URL}/api/session/${sessionName}/reconnect`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Reconectando sesi√≥n...');
                    setTimeout(loadSessions, 3000);
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        /**
         * Actualiza el contador de sesiones activas
         */
        function updateSessionsCount() {
            const ready = sessions.filter(s => s.state === 'READY').length;
            const total = sessions.length;
            document.getElementById('activeSessionsCount').textContent = 
                `${ready} de ${total} sesiones activas`;
        }
        
        /**
         * Pobla los checkboxes de sesi√≥n en los formularios
         */
        function populateSessionSelects() {
            const readySessions = sessions.filter(s => s.state === 'READY');
            
            // Generar checkboxes HTML
            const checkboxesHtml = readySessions.length > 0
                ? readySessions.map(s => `
                    <label class="flex items-center p-2 hover:bg-gray-100 rounded cursor-pointer">
                        <input type="checkbox" name="personalSession" value="${s.name}" class="mr-2 rounded text-blue-500">
                        <span class="flex-1 font-medium">${s.name}</span>
                        <span class="text-xs text-green-600">‚úÖ ${s.userInfo?.wid || ''}</span>
                    </label>
                `).join('')
                : '<p class="text-gray-500 text-sm">No hay sesiones activas</p>';
            
            const bulkCheckboxesHtml = readySessions.length > 0
                ? readySessions.map(s => `
                    <label class="flex items-center p-2 hover:bg-gray-100 rounded cursor-pointer">
                        <input type="checkbox" name="bulkSession" value="${s.name}" class="mr-2 rounded text-purple-500">
                        <span class="flex-1 font-medium">${s.name}</span>
                        <span class="text-xs text-green-600">‚úÖ ${s.userInfo?.wid || ''}</span>
                    </label>
                `).join('')
                : '<p class="text-gray-500 text-sm">No hay sesiones activas</p>';
            
            // Actualizar contenedores
            const personalContainer = document.getElementById('personalSessionCheckboxes');
            if (personalContainer) {
                personalContainer.innerHTML = checkboxesHtml;
            }
            
            const bulkContainer = document.getElementById('bulkSessionCheckboxes');
            if (bulkContainer) {
                bulkContainer.innerHTML = bulkCheckboxesHtml;
            }
        }
        
        /**
         * Obtiene las sesiones seleccionadas para mensaje personal
         */
        function getSelectedPersonalSessions() {
            const checkboxes = document.querySelectorAll('input[name="personalSession"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        /**
         * Obtiene las sesiones seleccionadas para env√≠o masivo
         */
        function getSelectedBulkSessions() {
            const checkboxes = document.querySelectorAll('input[name="bulkSession"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        /**
         * Selecciona todas las sesiones para env√≠o masivo
         */
        function selectAllBulkSessions() {
            document.querySelectorAll('input[name="bulkSession"]').forEach(cb => cb.checked = true);
        }
        
        /**
         * Deselecciona todas las sesiones para env√≠o masivo
         */
        function deselectAllBulkSessions() {
            document.querySelectorAll('input[name="bulkSession"]').forEach(cb => cb.checked = false);
        }
        
        /* ========================================
           FUNCIONES DE MENSAJE PERSONALIZADO
           ======================================== */
        
        /**
         * Env√≠a un mensaje personalizado desde m√∫ltiples sesiones
         */
        async function sendPersonalMessage() {
            const selectedSessions = getSelectedPersonalSessions();
            const phoneNumber = document.getElementById('personalPhone').value.trim();
            const message = document.getElementById('personalMessage').value.trim();
            const fileInput = document.getElementById('personalFile');
            const statusEl = document.getElementById('personalStatus');
            const button = document.getElementById('sendPersonalBtn');
            
            // Validaciones
            if (selectedSessions.length === 0) {
                statusEl.className = 'text-sm text-red-500';
                statusEl.textContent = 'Selecciona al menos una sesi√≥n';
                return;
            }
            
            if (!phoneNumber) {
                statusEl.className = 'text-sm text-red-500';
                statusEl.textContent = 'Ingresa el n√∫mero de tel√©fono';
                return;
            }
            
            if (!message && !fileInput.files[0]) {
                statusEl.className = 'text-sm text-red-500';
                statusEl.textContent = 'Escribe un mensaje o adjunta un archivo';
                return;
            }
            
            // Confirmar env√≠o m√∫ltiple
            if (selectedSessions.length > 1) {
                if (!confirm(`¬øEnviar mensaje desde ${selectedSessions.length} sesiones?\n\nSesiones: ${selectedSessions.join(', ')}`)) {
                    return;
                }
            }
            
            button.disabled = true;
            button.innerHTML = '<span class="spinner inline-block mr-2"></span> Enviando...';
            
            let sentCount = 0;
            let failedCount = 0;
            const file = fileInput.files[0];
            
            for (const sessionName of selectedSessions) {
                statusEl.className = 'text-sm text-blue-500';
                statusEl.textContent = `Enviando desde ${sessionName}...`;
                
                try {
                    let response;
                    
                    if (file) {
                        const formData = new FormData();
                        formData.append('sessionName', sessionName);
                        formData.append('phoneNumber', phoneNumber);
                        formData.append('caption', message || '');
                        formData.append('file', file);
                        
                        response = await fetch(`${API_URL}/api/session/send-file`, {
                            method: 'POST',
                            body: formData
                        });
                    } else {
                        response = await fetch(`${API_URL}/api/session/send-message`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ sessionName, phoneNumber, message })
                        });
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        sentCount++;
                    } else {
                        failedCount++;
                        console.error(`Error desde ${sessionName}:`, result.error);
                    }
                } catch (error) {
                    failedCount++;
                    console.error(`Error desde ${sessionName}:`, error);
                }
            }
            
            // Resultado final
            if (failedCount === 0) {
                statusEl.className = 'text-sm text-green-500';
                statusEl.textContent = `‚úÖ Mensaje enviado desde ${sentCount} sesi√≥n(es)`;
                document.getElementById('personalMessage').value = '';
                fileInput.value = '';
            } else if (sentCount > 0) {
                statusEl.className = 'text-sm text-yellow-500';
                statusEl.textContent = `‚ö†Ô∏è Enviado: ${sentCount} exitosos, ${failedCount} fallidos`;
            } else {
                statusEl.className = 'text-sm text-red-500';
                statusEl.textContent = `‚ùå Error: No se pudo enviar desde ninguna sesi√≥n`;
            }
            
            button.disabled = false;
            button.innerHTML = 'üì® Enviar Mensaje';
        }
        
        /* ========================================
           FUNCIONES DE ENV√çO MASIVO
           ======================================== */
        
        /**
         * Cambia entre pesta√±as de n√∫meros y grupos
         * @param {string} tab - 'numbers' o 'groups'
         */
        function switchBulkTab(tab) {
            bulkCurrentTab = tab;
            
            const tabNumbers = document.getElementById('tabNumbers');
            const tabGroups = document.getElementById('tabGroups');
            const panelNumbers = document.getElementById('panelNumbers');
            const panelGroups = document.getElementById('panelGroups');
            
            if (tab === 'numbers') {
                tabNumbers.className = 'px-4 py-2 border-b-2 border-purple-500 text-purple-600 font-medium';
                tabGroups.className = 'px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700';
                panelNumbers.classList.remove('hidden');
                panelGroups.classList.add('hidden');
            } else {
                tabNumbers.className = 'px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700';
                tabGroups.className = 'px-4 py-2 border-b-2 border-purple-500 text-purple-600 font-medium';
                panelNumbers.classList.add('hidden');
                panelGroups.classList.remove('hidden');
                loadGroups();
            }
        }
        
        /**
         * Carga los grupos de WhatsApp desde la primera sesi√≥n seleccionada
         */
        async function loadGroups() {
            const selectedSessions = getSelectedBulkSessions();
            const groupsList = document.getElementById('groupsList');
            
            if (selectedSessions.length === 0) {
                groupsList.innerHTML = '<p class="text-gray-500 text-sm">Selecciona al menos una sesi√≥n para ver los grupos</p>';
                return;
            }
            
            // Usar la primera sesi√≥n seleccionada para cargar grupos
            const sessionName = selectedSessions[0];
            groupsList.innerHTML = '<div class="flex items-center"><div class="spinner mr-2"></div> Cargando grupos de ' + sessionName + '...</div>';
            
            try {
                const response = await fetch(`${API_URL}/api/session/${sessionName}/groups`);
                const data = await response.json();
                
                if (data.success && data.groups && data.groups.length > 0) {
                    groupsList.innerHTML = data.groups.map(group => `
                        <label class="flex items-center p-2 hover:bg-gray-100 rounded cursor-pointer">
                            <input type="checkbox" name="bulkGroup" value="${group.id}" class="mr-2 rounded">
                            <span class="flex-1">${group.name}</span>
                            <span class="text-xs text-gray-400">${group.participants || '?'} miembros</span>
                        </label>
                    `).join('');
                } else {
                    groupsList.innerHTML = '<p class="text-gray-500 text-sm">No se encontraron grupos en ' + sessionName + '</p>';
                }
            } catch (error) {
                groupsList.innerHTML = `<p class="text-red-500 text-sm">Error: ${error.message}</p>`;
            }
        }
        
        /**
         * Env√≠a mensajes masivos desde m√∫ltiples sesiones
         */
        async function sendBulkMessages() {
            const selectedSessions = getSelectedBulkSessions();
            const message = document.getElementById('bulkMessage').value.trim();
            const delay = parseInt(document.getElementById('bulkDelay').value) * 1000;
            const fileInput = document.getElementById('bulkFileInput');
            const statusEl = document.getElementById('bulkStatus');
            const button = document.getElementById('sendBulkBtn');
            const progressContainer = document.getElementById('bulkProgress');
            const progressBar = document.getElementById('bulkProgressBar');
            const progressText = document.getElementById('bulkProgressText');
            
            // Validaciones
            if (selectedSessions.length === 0) {
                statusEl.className = 'text-sm text-red-500';
                statusEl.textContent = 'Selecciona al menos una sesi√≥n';
                return;
            }
            
            // Obtener destinatarios
            let recipients = [];
            let isGroupSend = false;
            
            if (bulkCurrentTab === 'numbers') {
                const contactsText = document.getElementById('bulkContacts').value.trim();
                if (!contactsText) {
                    statusEl.className = 'text-sm text-red-500';
                    statusEl.textContent = 'Ingresa los n√∫meros de tel√©fono';
                    return;
                }
                recipients = contactsText.split('\n')
                    .map(line => line.trim())
                    .filter(line => line && /^[0-9]+$/.test(line));
                    
                if (recipients.length === 0) {
                    statusEl.className = 'text-sm text-red-500';
                    statusEl.textContent = 'No se encontraron n√∫meros v√°lidos';
                    return;
                }
                
                if (recipients.length > 50) {
                    statusEl.className = 'text-sm text-red-500';
                    statusEl.textContent = 'M√°ximo 50 contactos por env√≠o';
                    return;
                }
            } else {
                const checkboxes = document.querySelectorAll('input[name="bulkGroup"]:checked');
                recipients = Array.from(checkboxes).map(cb => cb.value);
                isGroupSend = true;
                
                if (recipients.length === 0) {
                    statusEl.className = 'text-sm text-red-500';
                    statusEl.textContent = 'Selecciona al menos un grupo';
                    return;
                }
            }
            
            if (!message && !fileInput.files[0]) {
                statusEl.className = 'text-sm text-red-500';
                statusEl.textContent = 'Escribe un mensaje o adjunta un archivo';
                return;
            }
            
            // Confirmar env√≠o
            const recipientType = isGroupSend ? 'grupo(s)' : 'n√∫mero(s)';
            const totalMensajes = recipients.length * selectedSessions.length;
            if (!confirm(`¬øEnviar mensaje a ${recipients.length} ${recipientType} desde ${selectedSessions.length} sesi√≥n(es)?\n\nTotal de mensajes: ${totalMensajes}\nSesiones: ${selectedSessions.join(', ')}`)) return;
            
            // Iniciar env√≠o
            button.disabled = true;
            button.innerHTML = '<span class="spinner inline-block mr-2"></span> Enviando...';
            progressContainer.classList.remove('hidden');
            progressBar.style.width = '0%';
            
            let sentCount = 0;
            let failedCount = 0;
            const total = recipients.length * selectedSessions.length;
            const file = fileInput.files[0];
            let processed = 0;
            
            // Enviar desde cada sesi√≥n seleccionada
            for (const sessionName of selectedSessions) {
                statusEl.className = 'text-sm text-blue-500';
                statusEl.textContent = `Enviando desde ${sessionName}...`;
                
                for (let i = 0; i < recipients.length; i++) {
                    const recipient = recipients[i];
                    
                    try {
                        let response;
                        
                        if (file) {
                            const formData = new FormData();
                            formData.append('sessionName', sessionName);
                            formData.append('phoneNumber', recipient);
                            formData.append('caption', message || '');
                            formData.append('file', file);
                            
                            response = await fetch(`${API_URL}/api/session/send-file`, {
                                method: 'POST',
                                body: formData
                            });
                        } else {
                            response = await fetch(`${API_URL}/api/session/send-message`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    sessionName,
                                    phoneNumber: recipient,
                                    message
                                })
                            });
                        }
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            sentCount++;
                        } else {
                            failedCount++;
                        }
                    } catch (error) {
                        failedCount++;
                    }
                    
                    processed++;
                    
                    // Actualizar progreso
                    const progress = (processed / total) * 100;
                    progressBar.style.width = `${progress}%`;
                    progressText.textContent = `${processed}/${total} procesados (${sessionName})`;
                    
                    // Esperar delay
                    if (i < recipients.length - 1 || selectedSessions.indexOf(sessionName) < selectedSessions.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }
            
            // Resultado final
            if (failedCount === 0) {
                statusEl.className = 'text-sm text-green-500';
                statusEl.textContent = `‚úÖ Completado: ${sentCount} mensajes enviados desde ${selectedSessions.length} sesi√≥n(es)`;
            } else if (sentCount > 0) {
                statusEl.className = 'text-sm text-yellow-500';
                statusEl.textContent = `‚ö†Ô∏è Parcial: ${sentCount} enviados, ${failedCount} fallidos`;
            } else {
                statusEl.className = 'text-sm text-red-500';
                statusEl.textContent = `‚ùå Fallido: ${failedCount} mensajes no enviados`;
            }
            
            button.disabled = false;
            button.innerHTML = 'üöÄ Enviar Masivo';
            
            setTimeout(() => progressContainer.classList.add('hidden'), 3000);
        }
        
        /**
         * Limpia el formulario de env√≠o masivo
         */
        function clearBulkForm() {
            document.getElementById('bulkContacts').value = '';
            document.getElementById('bulkMessage').value = '';
            document.getElementById('bulkFileInput').value = '';
            document.getElementById('bulkStatus').textContent = '';
            document.getElementById('bulkProgress').classList.add('hidden');
            document.querySelectorAll('input[name="bulkGroup"]').forEach(cb => cb.checked = false);
        }
        
        /* ========================================
           INICIALIZACI√ìN
           ======================================== */
        
        // Actualizar sesiones peri√≥dicamente
        setInterval(() => {
            if (!document.getElementById('mainApp').classList.contains('hidden')) {
                loadSessions();
            }
        }, 30000);
    </script>
</body>
</html>
